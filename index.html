<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…ÙˆØ³ÙˆØ¹Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;800&display=swap" rel="stylesheet">
    <style>
        /* --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ø£Ù„ÙˆØ§Ù† --- */
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --primary: #f59e0b; /* Ø°Ù‡Ø¨ÙŠ */
            --text: #f1f5f9;
            --secondary: #94a3b8;
            --success: #10b981;
            --error: #ef4444;
            --loan: #8b5cf6;
            --disabled-bg: #334155;
            --shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Ø¯Ø¹Ù… Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ù„ØªÙ„ÙØ²ÙŠÙˆÙ† (Focus) --- */
        button:focus, .card:focus {
            transform: scale(1.05);
            box-shadow: 0 0 0 4px var(--primary);
            border-color: var(--primary) !important;
            z-index: 10;
        }

        /* --- Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */
        .app-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--surface); padding: 10px 20px;
            border-radius: 15px; box-shadow: var(--shadow);
            margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05);
            flex-shrink: 0;
        }

        .logo { font-size: 1.5rem; font-weight: 900; color: var(--primary); }
        
        .score-box {
            background: rgba(255,255,255,0.1); padding: 5px 15px;
            border-radius: 50px; font-weight: bold; font-size: 1.2rem;
            display: flex; align-items: center; gap: 5px;
        }

        .btn-reset {
            background: var(--error); color: white; border: none;
            padding: 8px 20px; border-radius: 10px; font-weight: bold;
            cursor: pointer; font-size: 1rem; margin-right: 10px;
        }

        /* --- Ø§Ù„Ø´Ø§Ø´Ø§Øª --- */
        .screen { display: none; flex: 1; flex-direction: column; overflow-y: auto; }
        .screen.active { display: flex; animation: fadein 0.5s; }
        @keyframes fadein { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* --- Ø§Ù„Ø´Ø¨ÙƒØ© (Grid) --- */
        .grid {
            display: grid;
            gap: 15px;
            padding: 5px;
            /* Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ */
            grid-template-columns: 1fr; 
        }

        /* ØªØ§Ø¨Ù„Øª */
        @media (min-width: 600px) { .grid { grid-template-columns: repeat(2, 1fr); } }
        /* ÙƒÙ…Ø¨ÙŠÙˆØªØ± ÙˆØªÙ„ÙØ§Ø² */
        @media (min-width: 1024px) { .grid { grid-template-columns: repeat(4, 1fr); } }

        /* --- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª --- */
        .card {
            background: var(--surface);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: 3px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 160px;
            box-shadow: var(--shadow);
            position: relative;
            transition: 0.2s;
        }

        .card-icon { font-size: 3.5rem; margin-bottom: 10px; }
        .card-title { font-size: 1.4rem; font-weight: bold; }
        .card-info { font-size: 0.9rem; color: var(--secondary); margin-top: 5px; }

        /* --- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù‚ÙÙ„Ø© (Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©) --- */
        .card.locked {
            background: var(--disabled-bg);
            opacity: 0.5;
            cursor: default;
            border-color: var(--secondary);
            pointer-events: none; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± */
        }
        .card.locked .card-icon { filter: grayscale(100%); }
        .completed-tag {
            position: absolute; top: 10px; left: 10px;
            background: var(--success); color: white;
            font-size: 0.8rem; padding: 2px 8px; border-radius: 5px;
            font-weight: bold;
        }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ --- */
        .game-header {
            display: flex; justify-content: space-between; margin-bottom: 20px;
            font-size: 1.2rem; font-weight: bold; color: var(--secondary);
        }

        .question-box {
            background: var(--surface); padding: 30px; border-radius: 20px;
            text-align: center; font-size: 1.8rem; font-weight: 800; line-height: 1.5;
            margin-bottom: 20px; flex-grow: 1; display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow); border: 2px solid #334155;
        }

        .options-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        @media (max-width: 600px) { .options-grid { grid-template-columns: 1fr; } .question-box { font-size: 1.4rem; } }

        .opt-btn {
            background: var(--surface); color: var(--text);
            border: 2px solid #334155; padding: 20px; border-radius: 12px;
            font-size: 1.3rem; font-weight: bold; cursor: pointer;
        }
        .opt-btn:hover { background: #334155; border-color: var(--primary); }
        
        .opt-btn.correct { background: var(--success) !important; border-color: var(--success) !important; color: white; }
        .opt-btn.wrong { background: var(--error) !important; border-color: var(--error) !important; color: white; opacity: 0.5; }

        /* --- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª (Ø§Ù„Ù†ÙˆØ§ÙØ°) --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999;
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }

        .modal-box {
            background: var(--surface); padding: 30px; border-radius: 20px;
            width: 90%; max-width: 400px; text-align: center;
            border: 2px solid var(--secondary); box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        .modal-title { font-size: 1.8rem; color: var(--primary); margin-bottom: 15px; font-weight: bold; }
        .modal-msg { font-size: 1.2rem; margin-bottom: 25px; line-height: 1.5; }
        
        .m-btn {
            padding: 12px 30px; border-radius: 10px; border: none;
            font-weight: bold; font-size: 1rem; cursor: pointer; margin: 5px;
        }
        .btn-ok { background: var(--success); color: white; }
        .btn-no { background: transparent; border: 2px solid var(--secondary); color: var(--text); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø·Ø£ (Ù„Ù„ØªØ´Ø®ÙŠØµ) */
        #debug-screen {
            position: fixed; inset: 0; background: #000; color: #f00; z-index: 10000;
            padding: 20px; overflow: auto; display: none; font-family: monospace; font-size: 16px;
        }
    </style>
</head>
<body>

<div id="debug-screen"></div>

<div class="app-container">
    <div class="header">
        <div class="logo">ğŸ’ Ø§Ù„Ù…ÙˆØ³ÙˆØ¹Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©</div>
        <div style="display:flex; align-items:center;">
            <div class="score-box">ğŸ’° <span id="score-val">0</span></div>
            <button class="btn-reset" onclick="confirmReset()">ØªØµÙÙŠØ± â†º</button>
        </div>
    </div>

    <div id="screen-home" class="screen active">
        <div class="grid" id="cat-grid"></div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-header">
            <button class="m-btn btn-no" onclick="goHome()">ğŸ  Ø®Ø±ÙˆØ¬</button>
            <span id="stage-txt">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1</span>
            <span id="q-count-txt"></span>
        </div>
        <div class="question-box" id="q-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div class="options-grid" id="opts-area"></div>
    </div>
</div>

<div id="modal-bank" class="modal-overlay">
    <div class="modal-box" style="border-color: var(--loan);">
        <div style="font-size:3rem">ğŸ¦</div>
        <div class="modal-title" style="color:var(--loan)">ØªÙ†Ø¨ÙŠÙ‡ Ø¥ÙÙ„Ø§Ø³</div>
        <div class="modal-msg">Ø±ØµÙŠØ¯Ùƒ Ù†ÙØ°! Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚Ø±Ø¶Ø§Ù‹ Ø¨Ù‚ÙŠÙ…Ø© <b>100 Ù†Ù‚Ø·Ø©</b>ØŸ<br><small>(ÙØ±ØµØ© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)</small></div>
        <button class="m-btn" style="background:var(--loan); color:white" onclick="takeLoan()">Ù…ÙˆØ§ÙÙ‚</button>
        <button class="m-btn btn-no" onclick="gameOver()">Ø¥ÙÙ„Ø§Ø³</button>
    </div>
</div>

<div id="modal-loss" class="modal-overlay">
    <div class="modal-box" style="border-color: var(--error);">
        <div style="font-size:3rem">ğŸ’¸</div>
        <div class="modal-title" style="color:var(--error)">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
        <div class="modal-msg">Ù„Ù… ÙŠØ¹Ø¯ Ù„Ø¯ÙŠÙƒ Ø±ØµÙŠØ¯ ÙˆÙ„Ø§ Ø£Ø³Ø¦Ù„Ø© ÙƒØ§ÙÙŠØ© Ù„Ù„ØªØ¹ÙˆÙŠØ¶.</div>
        <button class="m-btn btn-no" onclick="fullReset()">Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
    </div>
</div>

<script src="data.js"></script>

<script>
    // --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ (Ù„Ù„ØªÙ„ÙØ²ÙŠÙˆÙ†) ---
    window.onerror = function(msg, url, line) {
        var d = document.getElementById('debug-screen');
        d.style.display = 'block';
        d.innerHTML += "Error: " + msg + "<br>Line: " + line + "<br><hr>";
    };

    // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (ES5) ---
    var db = []; // Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    var state = {
        score: 0,
        loanUsed: false,
        solved: [] // Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©
    };
    var currentSession = {
        questions: [],
        index: 0,
        total: 3 // Ø«Ø§Ø¨ØªØ©: 3 Ø£Ø³Ø¦Ù„Ø© Ù„ÙƒÙ„ Ø¬ÙˆÙ„Ø©
    };

    // ØªØ¹Ø±ÙŠÙ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ±ØªÙŠØ¨
    var catKeys = [
        'Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…', 'Ø¥Ø³Ù„Ø§Ù…ÙŠØ§Øª', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§',
        'Ø§Ù„Ø¹Ù„ÙˆÙ…', 'Ø§Ù„Ø£Ø¯Ø¨ ÙˆØ§Ù„Ø´Ø¹Ø±', 'Ø§Ù„Ø±ÙŠØ§Ø¶Ø©', 'Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©'
    ];
    var catIcons = {
        'Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…': 'ğŸ“–', 'Ø¥Ø³Ù„Ø§Ù…ÙŠØ§Øª': 'ğŸ•Œ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®': 'âš”ï¸',
        'Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§': 'ğŸŒ', 'Ø§Ù„Ø¹Ù„ÙˆÙ…': 'ğŸ§¬', 'Ø§Ù„Ø£Ø¯Ø¨ ÙˆØ§Ù„Ø´Ø¹Ø±': 'âœ’ï¸',
        'Ø§Ù„Ø±ÙŠØ§Ø¶Ø©': 'âš½', 'Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©': 'ğŸ’¡'
    };

    // --- Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ---
    window.onload = function() {
        try {
            if (typeof gameData !== 'undefined') {
                db = gameData;
                loadData();
                renderHome();
                setupRemoteControl();
            } else {
                alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù data.js");
            }
        } catch (e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„: " + e.message);
        }
    };

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
    function renderHome() {
        var grid = document.getElementById('cat-grid');
        grid.innerHTML = '';

        for (var i = 0; i < catKeys.length; i++) {
            var key = catKeys[i];
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© ØªØµÙÙŠØ© Ø¨Ø³ÙŠØ·Ø©
            var totalInCat = 0;
            var remainingInCat = 0;
            
            for (var j = 0; j < db.length; j++) {
                var q = db[j];
                var qCat = getCategory(q);
                if (qCat === key) {
                    totalInCat++;
                    if (state.solved.indexOf(q.id) === -1) {
                        remainingInCat++;
                    }
                }
            }

            var btn = document.createElement('div');
            btn.className = 'card';
            
            // Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ¨Ù‚ Ø£Ø³Ø¦Ù„Ø©)
            if (remainingInCat === 0 && totalInCat > 0) {
                btn.className += ' locked';
                btn.innerHTML = '<div class="completed-tag">Ù…ÙƒØªÙ…Ù„ âœ”</div>';
                // Ø¥Ø²Ø§Ù„Ø© tabindex Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¨Ø§Ù„Ø±ÙŠÙ…ÙˆØª
                btn.removeAttribute('tabindex'); 
            } else {
                btn.tabIndex = 0; // Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ±ÙƒÙŠØ²
                // Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Scope ÙÙŠ Ø§Ù„Ù€ Loop (ES5 Closure)
                (function(k) {
                    btn.onclick = function() { startSession(k); };
                    btn.onkeydown = function(e) { if(e.key === 'Enter') startSession(k); };
                })(key);
            }

            btn.innerHTML += 
                '<div class="card-icon">' + catIcons[key] + '</div>' +
                '<div class="card-title">' + key + '</div>' +
                '<div class="card-info">' + remainingInCat + ' Ù…ØªØ¨Ù‚ÙŠ</div>';

            grid.appendChild(btn);
        }
        updateScore();
        showScreen('screen-home');
        
        // ØªØ±ÙƒÙŠØ² Ù…Ø¨Ø¯Ø¦ÙŠ Ù„Ø£ÙˆÙ„ Ø¨Ø·Ø§Ù‚Ø© Ù…ÙØªÙˆØ­Ø©
        setTimeout(function(){
            var firstCard = document.querySelector('.card:not(.locked)');
            if(firstCard) firstCard.focus();
        }, 200);
    }

    function getCategory(q) {
        var t = (q.category + " " + q.question).toLowerCase();
        if (t.indexOf('Ù‚Ø±Ø¢Ù†') > -1 || t.indexOf('Ø³ÙˆØ±Ø©') > -1 || t.indexOf('Ø¢ÙŠØ©') > -1) return 'Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…';
        if (t.indexOf('ØªØ§Ø±ÙŠØ®') > -1 || t.indexOf('Ø³ÙŠØ±Ø©') > -1 || t.indexOf('ØºØ²ÙˆØ©') > -1) return 'Ø§Ù„ØªØ§Ø±ÙŠØ®';
        if (t.indexOf('Ø¬ØºØ±Ø§ÙÙŠØ§') > -1 || t.indexOf('Ø¹Ø§ØµÙ…Ø©') > -1 || t.indexOf('Ù…Ø¯Ù†') > -1) return 'Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§';
        if (t.indexOf('Ø¹Ù„ÙˆÙ…') > -1 || t.indexOf('ÙØ¶Ø§Ø¡') > -1 || t.indexOf('Ø·Ø¨') > -1) return 'Ø§Ù„Ø¹Ù„ÙˆÙ…';
        if (t.indexOf('Ø£Ø¯Ø¨') > -1 || t.indexOf('Ø´Ø¹Ø±') > -1 || t.indexOf('Ù…Ø¤Ù„Ù') > -1) return 'Ø§Ù„Ø£Ø¯Ø¨ ÙˆØ§Ù„Ø´Ø¹Ø±';
        if (t.indexOf('Ø±ÙŠØ§Ø¶Ø©') > -1 || t.indexOf('ÙƒØ±Ø©') > -1 || t.indexOf('ÙƒØ£Ø³') > -1) return 'Ø§Ù„Ø±ÙŠØ§Ø¶Ø©';
        if (t.indexOf('Ø¥Ø³Ù„Ø§Ù…') > -1 || t.indexOf('ÙÙ‚Ù‡') > -1 || t.indexOf('Ù†Ø¨ÙŠ') > -1) return 'Ø¥Ø³Ù„Ø§Ù…ÙŠØ§Øª';
        return 'Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©';
    }

    function startSession(catKey) {
        // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ
        var available = [];
        for (var i = 0; i < db.length; i++) {
            if (getCategory(db[i]) === catKey && state.solved.indexOf(db[i].id) === -1) {
                available.push(db[i]);
            }
        }

        if (available.length === 0) return;

        // Ø®Ù„Ø· ÙˆØ§Ø®ØªÙŠØ§Ø± 3 Ø£Ø³Ø¦Ù„Ø©
        available.sort(function() { return 0.5 - Math.random(); });
        currentSession.questions = available.slice(0, 3);
        currentSession.index = 0;
        
        loadQuestion();
        showScreen('screen-game');
    }

    function loadQuestion() {
        var q = currentSession.questions[currentSession.index];
        var stage = currentSession.index + 1;
        
        document.getElementById('stage-txt').innerText = "Ø§Ù„Ù…Ø±Ø­Ù„Ø© " + stage;
        document.getElementById('q-count-txt').innerText = stage + "/3";
        document.getElementById('q-text').innerText = q.question;

        var area = document.getElementById('opts-area');
        area.innerHTML = '';

        // Ù†Ø³Ø® Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙˆØ®Ù„Ø·Ù‡Ø§
        var opts = q.options.slice();
        opts.sort(function() { return 0.5 - Math.random(); });

        for (var i = 0; i < opts.length; i++) {
            var btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opts[i];
            
            (function(opt, button) {
                button.onclick = function() { checkAnswer(button, opt === q.answer); };
            })(opts[i], btn);

            area.appendChild(btn);
        }
        
        // ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø®ÙŠØ§Ø±
        setTimeout(function(){
            var firstOpt = area.querySelector('button');
            if(firstOpt) firstOpt.focus();
        }, 100);
    }

    function checkAnswer(btn, isCorrect) {
        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        var all = document.querySelectorAll('.opt-btn');
        for (var i = 0; i < all.length; i++) all[i].onclick = null;

        var q = currentSession.questions[currentSession.index];
        
        if (isCorrect) {
            btn.className += ' correct';
            state.score += 50; // Ø¬Ø§Ø¦Ø²Ø© Ø«Ø§Ø¨ØªØ© 50
            state.solved.push(q.id); // Ù‚ÙÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ø£Ø¨Ø¯
            saveData();
            setTimeout(nextQuestion, 1000);
        } else {
            btn.className += ' wrong';
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
            for (var j = 0; j < all.length; j++) {
                if (all[j].innerText === q.answer) all[j].className += ' correct';
            }
            
            // Ø§Ù„Ø®ØµÙ…
            state.score -= 50; // Ø®ØµÙ… Ø«Ø§Ø¨Øª
            updateScore();

            // ÙØ­Øµ Ø§Ù„Ø®Ø³Ø§Ø±Ø©
            if (state.score < 0) {
                if (!state.loanUsed) {
                    setTimeout(function(){ showModal('modal-bank'); }, 1000);
                } else {
                    // Ù‡Ù„ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹ÙˆÙŠØ¶ØŸ
                    checkBankruptcy();
                }
            } else {
                setTimeout(nextQuestion, 2000);
            }
        }
        updateScore();
    }

    function checkBankruptcy() {
        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙƒÙƒÙ„
        var remainingTotal = 0;
        for (var i = 0; i < db.length; i++) {
            if (state.solved.indexOf(db[i].id) === -1) remainingTotal++;
        }
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† (Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ + ÙƒÙ„ Ù…Ø§ ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø­Ù‡) < 0 ... Ø¥ÙÙ„Ø§Ø³
        var maxPotential = remainingTotal * 50;
        if ((state.score + maxPotential) < 0) {
            setTimeout(gameOver, 1000);
        } else {
            setTimeout(nextQuestion, 2000);
        }
    }

    function nextQuestion() {
        currentSession.index++;
        if (currentSession.index >= currentSession.questions.length) {
            // Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø© (3 Ø£Ø³Ø¦Ù„Ø©)
            goHome();
        } else {
            loadQuestion();
        }
    }

    // --- Ø§Ù„Ø¨Ù†Ùƒ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Ø³ ---
    function takeLoan() {
        state.score += 100; // Ø§Ù„Ù‚Ø±Ø¶ 100
        state.loanUsed = true;
        updateScore();
        hideModal('modal-bank');
        setTimeout(nextQuestion, 500);
    }

    function gameOver() {
        hideModal('modal-bank');
        showModal('modal-loss');
    }

    function fullReset() {
        localStorage.removeItem('gold_v_final');
        location.reload();
    }

    function confirmReset() {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡ØŸ")) fullReset();
    }

    // --- Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    function showScreen(id) {
        var screens = document.querySelectorAll('.screen');
        for (var i = 0; i < screens.length; i++) screens[i].className = 'screen';
        document.getElementById(id).className = 'screen active';
    }

    function showModal(id) {
        document.getElementById(id).className = 'modal-overlay open';
        document.getElementById(id).querySelector('button').focus();
    }

    function hideModal(id) {
        document.getElementById(id).className = 'modal-overlay';
    }

    function updateScore() {
        var el = document.getElementById('score-val');
        el.innerText = state.score;
        el.style.color = state.score < 0 ? 'var(--error)' : 'var(--primary)';
    }

    function goHome() {
        renderHome();
    }

    function saveData() {
        localStorage.setItem('gold_v_final', JSON.stringify(state));
    }

    function loadData() {
        var s = localStorage.getItem('gold_v_final');
        if (s) {
            state = JSON.parse(s);
            if (!state.solved) state.solved = [];
        }
    }

    // --- Ø¯Ø¹Ù… Ø§Ù„Ø±ÙŠÙ…ÙˆØª ÙƒÙ†ØªØ±ÙˆÙ„ (Ø§Ù„Ø£Ø³Ù‡Ù…) ---
    function setupRemoteControl() {
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' || e.key === 'Escape') {
                var modals = document.querySelectorAll('.modal-overlay.open');
                if (modals.length > 0) {
                    for(var m=0; m<modals.length; m++) modals[m].className = 'modal-overlay';
                } else if (document.getElementById('screen-game').className.indexOf('active') > -1) {
                    goHome();
                }
            }

            // Ø§Ù„ØªÙ†Ù‚Ù„
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].indexOf(e.key) > -1) {
                var focusable = document.querySelectorAll('button, [tabindex="0"]');
                var arr = Array.prototype.slice.call(focusable).filter(function(el) {
                    return el.offsetParent !== null; // Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙ‚Ø·
                });
                
                var index = arr.indexOf(document.activeElement);
                var next = index;

                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') next++;
                if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') next--;

                if (next >= 0 && next < arr.length) {
                    arr[next].focus();
                    e.preventDefault();
                }
            }
        });
    }
</script>
</body>
</html>