<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…ÙˆØ³ÙˆØ¹Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;800&display=swap" rel="stylesheet">
    <style>
        /* --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† --- */
        :root {
            --bg: #0f172a; --surface: #1e293b; --surface-hover: #334155;
            --primary: #f59e0b; --text: #f1f5f9; --text-sec: #94a3b8;
            --success: #10b981; --error: #ef4444; --loan: #8b5cf6;
            --shadow: 0 8px 20px rgba(0,0,0,0.4); --radius: 16px;
        }
        [data-theme="light"] {
            --bg: #f8fafc; --surface: #ffffff; --surface-hover: #e2e8f0;
            --primary: #d97706; --text: #0f172a; --text-sec: #64748b;
            --shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--bg); color: var(--text); font-family: 'Tajawal', sans-serif;
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            transition: background-color 0.3s;
        }

        /* --- Ø¥Ø·Ø§Ø± Ø§Ù„ØªØ±ÙƒÙŠØ² (Accessibility & TV) --- */
        *:focus-visible {
            outline: 3px solid var(--primary); outline-offset: 4px; border-radius: 8px; z-index: 100;
        }

        /* --- Ø§Ù„Ù‡ÙŠÙƒÙ„ --- */
        .app-container {
            width: 100%; max-width: 1600px; margin: 0 auto; height: 100%;
            display: flex; flex-direction: column; padding: 20px;
        }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--surface); padding: 10px 25px; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 20px; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.05);
        }

        .grid {
            display: grid; gap: 20px; padding: 10px; overflow-y: auto;
            grid-template-columns: 1fr; /* Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        }
        @media (min-width: 600px) { .grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { .grid { grid-template-columns: repeat(4, 1fr); } }

        /* --- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª --- */
        .card {
            background: var(--surface); border-radius: var(--radius); padding: 20px;
            text-align: center; cursor: pointer; transition: 0.2s; border: 2px solid transparent;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 180px; box-shadow: var(--shadow); position: relative; overflow: hidden;
        }
        
        .card:hover:not(.disabled) {
            transform: translateY(-5px); border-color: var(--primary); background: var(--surface-hover);
        }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù‚ÙÙ„ (Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ÙƒØªÙ…Ù„) */
        .card.disabled {
            background: var(--surface-hover); 
            opacity: 0.5; 
            cursor: default; 
            pointer-events: none; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± */
            border-color: #334155;
            filter: grayscale(100%);
        }
        
        .completed-overlay {
            position: absolute; inset: 0; background: rgba(16, 185, 129, 0.15);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--success); font-weight: 900; opacity: 0; transition: 0.3s;
        }
        .card.disabled .completed-overlay { opacity: 1; }
        .checkmark { font-size: 3rem; margin-bottom: 5px; }

        .card-icon { font-size: 3.5rem; margin-bottom: 10px; }
        .card-title { font-size: 1.3rem; font-weight: 800; }
        .card-info { font-size: 0.9rem; color: var(--text-sec); margin-top: 5px; }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨ --- */
        .screen { display: none; flex: 1; flex-direction: column; animation: fadeIn 0.4s ease; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .game-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .question-box {
            background: var(--surface); padding: 40px; border-radius: 25px;
            text-align: center; font-size: 1.8rem; font-weight: 800; line-height: 1.6;
            margin-bottom: 30px; flex-grow: 1; display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--surface-hover); box-shadow: var(--shadow);
        }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 700px) { .options-grid { grid-template-columns: 1fr; } }

        .opt-btn {
            background: var(--surface); color: var(--text); border: 2px solid var(--surface-hover);
            padding: 20px; border-radius: 15px; font-size: 1.3rem; font-weight: bold;
            cursor: pointer; transition: 0.2s;
        }
        .opt-btn:hover, .opt-btn:focus { background: var(--surface-hover); border-color: var(--primary); transform: scale(1.02); }
        .opt-btn.correct { background: var(--success) !important; border-color: var(--success) !important; color: white !important; }
        .opt-btn.wrong { background: var(--error) !important; border-color: var(--error) !important; color: white !important; opacity: 0.6; }

        /* --- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(8px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        
        .modal-card {
            background: var(--surface); width: 90%; max-width: 450px; padding: 30px;
            border-radius: 25px; text-align: center; border: 1px solid var(--surface-hover);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform: scale(0.8); transition: 0.3s;
        }
        .modal-overlay.open .modal-card { transform: scale(1); }

        .modal-icon { font-size: 4rem; margin-bottom: 10px; }
        .modal-title { font-size: 1.8rem; font-weight: 900; margin-bottom: 10px; color: var(--primary); }
        .modal-text { font-size: 1.1rem; line-height: 1.6; margin-bottom: 25px; color: var(--text-sec); }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }

        .btn { padding: 12px 25px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-danger { background: var(--error); color: white; }
        .btn-sec { background: transparent; border: 2px solid var(--surface-hover); color: var(--text); }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(50px);
            background: #334155; color: white; padding: 12px 30px; border-radius: 50px;
            opacity: 0; transition: 0.3s; font-weight: bold; z-index: 6000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div style="font-size: 1.5rem; font-weight: 900; color: var(--primary); display:flex; align-items:center; gap:10px;">
            <span>ğŸ’</span> Ø§Ù„Ù…ÙˆØ³ÙˆØ¹Ø©
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div style="background: rgba(255,255,255,0.05); padding: 8px 15px; border-radius: 50px; font-weight: bold;">
                ğŸ’° <span id="score-display">0</span>
            </div>
            <button class="btn btn-sec" onclick="toggleTheme()" style="padding: 8px 12px;">ğŸŒ—</button>
            <button class="btn btn-danger" onclick="showResetModal()">â†º ØªØµÙÙŠØ±</button>
        </div>
    </div>

    <div id="screen-home" class="screen active">
        <div class="grid" id="categories-grid"></div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-header">
            <button class="btn btn-sec" onclick="endSession()">ğŸ  Ø®Ø±ÙˆØ¬</button>
            <span id="stage-badge" style="background: var(--surface-hover); padding: 5px 15px; border-radius: 15px;">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1</span>
            <span id="q-counter"></span>
        </div>
        <div class="question-box" id="q-text">...</div>
        <div class="options-grid" id="opts-container"></div>
    </div>
</div>

<div class="modal-overlay" id="bank-modal">
    <div class="modal-card">
        <div class="modal-icon">ğŸ¦</div>
        <div class="modal-title">ØªÙ†Ø¨ÙŠÙ‡ Ø¥ÙÙ„Ø§Ø³!</div>
        <p class="modal-text">Ø±ØµÙŠØ¯Ùƒ Ù†ÙØ°! Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚Ø±Ø¶ Ø¥Ù†Ù‚Ø§Ø° Ø¨Ù‚ÙŠÙ…Ø© <b>150 Ù†Ù‚Ø·Ø©</b>ØŸ<br><small>(ÙŠÙƒÙÙŠ Ù„Ù€ 3 Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø®Ø§Ø·Ø¦Ø©)</small></p>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="takeLoan()">Ù…ÙˆØ§ÙÙ‚</button>
            <button class="btn btn-sec" onclick="declareBankruptcy()">Ø¥ÙÙ„Ø§Ø³</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="gameover-modal">
    <div class="modal-card">
        <div class="modal-icon">ğŸ’¸</div>
        <div class="modal-title" style="color:var(--error)">Ø®Ø³Ø±Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
        <p class="modal-text" id="gameover-text">Ø±ØµÙŠØ¯Ùƒ Ø³Ø§Ù„Ø¨ ÙˆÙ„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙƒØ§ÙÙŠØ© Ù„ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ø®Ø³Ø§Ø±Ø©!</p>
        <div class="modal-actions">
            <button class="btn btn-danger" onclick="fullReset()">Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="reset-modal">
    <div class="modal-card">
        <div class="modal-title">ØªØµÙÙŠØ± Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
        <p class="modal-text">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ØªÙ‚Ø¯Ù….</p>
        <div class="modal-actions">
            <button class="btn btn-danger" onclick="fullReset()">Ù†Ø¹Ù…ØŒ Ù…Ø³Ø­</button>
            <button class="btn btn-sec" onclick="closeModal('reset-modal')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script src="data.js"></script>
<script>
    // Ø§Ù„ØµÙˆØª
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if(type==='correct'){
            osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1000, now+0.1);
            gain.gain.linearRampToValueAtTime(0, now+0.3); osc.start(); osc.stop(now+0.3);
        } else if(type==='wrong'){
            osc.type='sawtooth'; osc.frequency.setValueAtTime(150, now);
            gain.gain.linearRampToValueAtTime(0, now+0.4); osc.start(); osc.stop(now+0.4);
        }
    }

    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    let db = [];
    let state = { score: 0, loanUsed: false, loanActive: false, solved: [] };
    let session = { questions: [], index: 0, stage: 1, totalQ: 3 }; 
    
    const categories = {
        'Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…': 'ğŸ“–', 'Ø¥Ø³Ù„Ø§Ù…ÙŠØ§Øª': 'ğŸ•Œ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®': 'âš”ï¸',
        'Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§': 'ğŸŒ', 'Ø§Ù„Ø¹Ù„ÙˆÙ…': 'ğŸ§¬', 'Ø§Ù„Ø£Ø¯Ø¨ ÙˆØ§Ù„Ø´Ø¹Ø±': 'âœ’ï¸',
        'Ø§Ù„Ø±ÙŠØ§Ø¶Ø©': 'âš½', 'Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©': 'ğŸ’¡'
    };
    
    let catLists = {};

    window.onload = function() {
        if(typeof gameData !== 'undefined') {
            db = gameData;
            loadState();
            categorizeData();
            renderHome();
        }
    };

    function categorizeData() {
        for(let k in categories) catLists[k] = [];
        db.forEach(q => {
            const t = ((q.category||"") + " " + (q.question||"")).toLowerCase();
            let cat = 'Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©';
            if(t.includes('Ù‚Ø±Ø¢Ù†')||t.includes('Ø³ÙˆØ±Ø©')||t.includes('Ø¢ÙŠØ©')) cat='Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…';
            else if(t.includes('ØªØ§Ø±ÙŠØ®')||t.includes('Ø³ÙŠØ±Ø©')||t.includes('ØºØ²ÙˆØ©')||t.includes('Ù…Ø¹Ø±ÙƒØ©')||t.includes('Ø±Ø¦ÙŠØ³')) cat='Ø§Ù„ØªØ§Ø±ÙŠØ®';
            else if(t.includes('Ø¬ØºØ±Ø§ÙÙŠØ§')||t.includes('Ø¹Ø§ØµÙ…Ø©')||t.includes('Ø¯ÙˆÙ„')||t.includes('Ù…Ø¯Ù†')) cat='Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§';
            else if(t.includes('Ø¹Ù„ÙˆÙ…')||t.includes('ÙØ¶Ø§Ø¡')||t.includes('ÙƒÙŠÙ…ÙŠØ§Ø¡')||t.includes('Ø­ÙŠÙˆØ§Ù†')||t.includes('Ø·Ø¨')) cat='Ø§Ù„Ø¹Ù„ÙˆÙ…';
            else if(t.includes('Ø£Ø¯Ø¨')||t.includes('Ø´Ø¹Ø±')||t.includes('Ù…Ø¤Ù„Ù')||t.includes('Ø±ÙˆØ§ÙŠØ©')) cat='Ø§Ù„Ø£Ø¯Ø¨ ÙˆØ§Ù„Ø´Ø¹Ø±';
            else if(t.includes('Ø±ÙŠØ§Ø¶Ø©')||t.includes('ÙƒØ±Ø©')||t.includes('ÙƒØ£Ø³')||t.includes('Ù„Ø§Ø¹Ø¨')) cat='Ø§Ù„Ø±ÙŠØ§Ø¶Ø©';
            else if(t.includes('Ø¥Ø³Ù„Ø§Ù…')||t.includes('ÙÙ‚Ù‡')||t.includes('Ù†Ø¨ÙŠ')||t.includes('ØµØ­Ø§Ø¨ÙŠ')) cat='Ø¥Ø³Ù„Ø§Ù…ÙŠØ§Øª';
            if(catLists[cat]) catLists[cat].push(q.id);
        });
    }

    function renderHome() {
        const grid = document.getElementById('categories-grid');
        grid.innerHTML = '';
        const keys = Object.keys(categories).sort((a,b) => (a==='Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…' ? -1 : 1));

        keys.forEach(k => {
            const allIds = catLists[k];
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
            const remainingIds = allIds.filter(id => !state.solved.includes(id));
            const isDone = remainingIds.length === 0 && allIds.length > 0;
            
            const div = document.createElement('div');
            // Ø¥Ø°Ø§ Ù…ÙƒØªÙ…Ù„: Ù†Ø¶ÙŠÙ ÙƒÙ„Ø§Ø³ disabled ÙˆÙ†Ø²ÙŠÙ„ tabindex Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØ±ÙƒÙŠØ²
            div.className = `card ${isDone ? 'disabled' : ''}`;
            div.tabIndex = isDone ? -1 : 0;
            
            div.innerHTML = `
                ${isDone ? '<div class="completed-overlay"><div class="checkmark">âœ”</div>Ù…ÙƒØªÙ…Ù„</div>' : ''}
                <div class="card-icon">${categories[k]}</div>
                <div class="card-title">${k}</div>
                <div class="card-info">${remainingIds.length} Ù…ØªØ¨Ù‚ÙŠ / ${allIds.length}</div>
            `;

            // Ø§Ù„ØªÙØ§Ø¹Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙƒØªÙ…Ù„
            if(!isDone && allIds.length > 0) {
                div.onclick = () => startSession(k);
                div.onkeydown = (e) => { if(e.key==='Enter') startSession(k); };
            }
            // Ø¥Ø°Ø§ Ù…ÙƒØªÙ…Ù„: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¯Ø« onclick
            
            grid.appendChild(div);
        });
        updateUI();
        switchScreen('screen-home');
        // ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø¨Ø·Ø§Ù‚Ø© Ù…ÙØ¹Ù„Ø©
        setTimeout(() => { const c = document.querySelector('.card:not(.disabled)'); if(c) c.focus(); }, 100);
    }

    function startSession(catKey) {
        const allIds = catLists[catKey];
        const availableIds = allIds.filter(id => !state.solved.includes(id));

        if(availableIds.length === 0) {
            renderHome(); return;
        }

        // Ø§Ø®ØªÙŠØ§Ø± 3 Ø£Ø³Ø¦Ù„Ø© ÙÙ‚Ø·
        let count = 3;
        if(availableIds.length < 3) count = availableIds.length;

        let selectedIds = [...availableIds].sort(() => 0.5 - Math.random()).slice(0, count);
        
        session.questions = selectedIds.map(id => db.find(q => q.id === id));
        session.index = 0;
        session.totalQ = count;
        
        loadQuestion();
        switchScreen('screen-game');
    }

    function loadQuestion() {
        session.stage = session.index + 1;
        document.getElementById('stage-badge').innerText = `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${session.stage}`;
        document.getElementById('q-counter').innerText = `${session.index + 1}/${session.totalQ}`;
        
        const q = session.questions[session.index];
        document.getElementById('q-text').innerText = q.question;
        
        const grid = document.getElementById('opts-container');
        grid.innerHTML = '';
        
        let opts = q.options ? [...q.options] : [q.answer];
        opts.sort(() => 0.5 - Math.random());

        opts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(btn, opt === q.answer);
            grid.appendChild(btn);
        });
        setTimeout(() => document.querySelector('.opt-btn').focus(), 100);
    }

    function checkAnswer(btn, isCorrect) {
        document.querySelectorAll('.opt-btn').forEach(b => b.onclick = null);
        
        const penalty = 50; 
        const reward = session.stage * 20;

        if(isCorrect) {
            btn.classList.add('correct');
            playTone('correct');
            state.score += reward;
            state.solved.push(session.questions[session.index].id); 
            
            if(state.loanActive && state.score >= 0) {
                state.loanActive = false;
                showToast("ØªÙ… Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø±Ø¶! âœ…");
            }
            saveState();
            setTimeout(nextQ, 1200);
        } else {
            btn.classList.add('wrong');
            playTone('wrong');
            document.querySelectorAll('.opt-btn').forEach(b => {
                if(b.innerText === session.questions[session.index].answer) b.classList.add('correct');
            });
            state.score -= penalty;
            updateUI();

            if(state.score < 0) {
                if(!state.loanUsed) {
                    setTimeout(() => openModal('bank-modal'), 1000);
                } else {
                    // Ù‡Ù†Ø§: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ¹ÙˆÙŠØ¶
                    checkBankruptcy();
                }
            } else {
                setTimeout(nextQ, 2000);
            }
        }
        updateUI();
    }

    function checkBankruptcy() {
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (ØºÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©)
        let totalRemainingQs = 0;
        for(let k in catLists) {
            totalRemainingQs += catLists[k].filter(id => !state.solved.includes(id)).length;
        }
        
        // Ø£Ù‚ØµÙ‰ Ø±Ø¨Ø­ Ù…Ù…ÙƒÙ† (ÙƒÙ„ Ø³Ø¤Ø§Ù„ Ø¨Ù€ 60 Ù†Ù‚Ø·Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
        let maxPossibleGain = totalRemainingQs * 60;
        
        // Ø§Ù„Ø´Ø±Ø·: Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ + Ø£Ù‚ØµÙ‰ Ø±Ø¨Ø­ < 0
        if((state.score + maxPossibleGain) < 0) {
            document.getElementById('gameover-text').innerHTML = 
                `Ø±ØµÙŠØ¯Ùƒ: ${state.score}<br>ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ø§ ØªÙƒÙÙŠ Ù„ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ø®Ø³Ø§Ø±Ø©.`;
            setTimeout(() => openModal('gameover-modal'), 1000);
        } else {
            setTimeout(nextQ, 2000);
        }
    }

    function nextQ() {
        session.index++;
        if(session.index >= session.totalQ) {
            showToast("ğŸ‰ Ù…Ø±Ø­Ù„Ø© Ù…ÙƒØªÙ…Ù„Ø©!");
            setTimeout(endSession, 1500);
        } else {
            loadQuestion();
        }
    }

    function openModal(id) {
        document.getElementById(id).classList.add('open');
        document.getElementById(id).querySelector('button').focus();
    }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    
    function takeLoan() {
        state.score += 150; state.loanUsed = true; state.loanActive = true;
        updateUI(); closeModal('bank-modal');
        showToast("ØªÙ… Ø¥ÙŠØ¯Ø§Ø¹ 150 Ù†Ù‚Ø·Ø© ğŸ’°");
        setTimeout(nextQ, 1000);
    }
    function declareBankruptcy() { closeModal('bank-modal'); openModal('gameover-modal'); }
    function showResetModal() { openModal('reset-modal'); }
    
    function fullReset() { localStorage.removeItem('gold_quiz_final_v3'); location.reload(); }
    
    function endSession() { renderHome(); }
    function updateUI() {
        const el = document.getElementById('score-display');
        el.innerText = state.score;
        el.style.color = state.score < 0 ? 'var(--error)' : 'var(--primary)';
    }
    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }
    function toggleTheme() {
        const b = document.body;
        b.setAttribute('data-theme', b.getAttribute('data-theme')==='light'?'':'light');
    }
    function saveState() { localStorage.setItem('gold_quiz_final_v3', JSON.stringify(state)); }
    function loadState() {
        const s = localStorage.getItem('gold_quiz_final_v3');
        if(s) state = JSON.parse(s);
        if(!state.solved) state.solved = [];
    }

    // Ø±ÙŠÙ…ÙˆØª Ø§Ù„ØªÙ„ÙØ§Ø²
    document.addEventListener('keydown', (e) => {
        if(e.key === 'Backspace' || e.key === 'Escape') {
            if(document.querySelector('.modal-overlay.open')) {
                document.querySelector('.modal-overlay.open').classList.remove('open');
            } else if(document.getElementById('screen-game').classList.contains('active')) {
                endSession();
            }
        }
        const focusable = Array.from(document.querySelectorAll('div.card:not(.disabled), button, [tabindex="0"]'))
                               .filter(el => el.offsetParent !== null);
        const index = focusable.indexOf(document.activeElement);
        let next = index;
        if(e.key === 'ArrowRight' || e.key === 'ArrowDown') next++;
        if(e.key === 'ArrowLeft' || e.key === 'ArrowUp') next--;
        if(next >= 0 && next < focusable.length) focusable[next].focus();
    });
</script>
</body>
</html>